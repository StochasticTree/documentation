<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "https://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" lang="en-US">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=11"/>
<meta name="generator" content="Doxygen 1.9.8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>StochTree: Leaf Model API</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<script type="text/x-mathjax-config">
MathJax.Hub.Config({
  extensions: ["tex2jax.js"],
  jax: ["input/TeX","output/HTML-CSS"],
});
</script>
<script type="text/javascript" async="async" src="https://cdn.jsdelivr.net/npm/mathjax@2/MathJax.js"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr id="projectrow">
  <td id="projectalign">
   <div id="projectname">StochTree<span id="projectnumber">&#160;0.0.1</span>
   </div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.9.8 -->
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
var searchBox = new SearchBox("searchBox", "search/",'.html');
/* @license-end */
</script>
<script type="text/javascript" src="menudata.js"></script>
<script type="text/javascript" src="menu.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
$(function() {
  initMenu('',true,false,'search.php','Search');
  $(document).ready(function() { init_search(); });
});
/* @license-end */
</script>
<div id="main-nav"></div>
</div><!-- top -->
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<div id="MSearchResults">
<div class="SRPage">
<div id="SRIndex">
<div id="SRResults"></div>
<div class="SRStatus" id="Loading">Loading...</div>
<div class="SRStatus" id="Searching">Searching...</div>
<div class="SRStatus" id="NoMatches">No Matches</div>
</div>
</div>
</div>
</div>

<div class="header">
  <div class="summary">
<a href="#nested-classes">Classes</a> &#124;
<a href="#typedef-members">Typedefs</a> &#124;
<a href="#enum-members">Enumerations</a> &#124;
<a href="#func-members">Functions</a>  </div>
  <div class="headertitle"><div class="title">Leaf Model API</div></div>
</div><!--header-->
<div class="contents">

<p>Classes / functions for implementing leaf models.  
<a href="#details">More...</a></p>
<table class="memberdecls">
<tr class="heading"><td colspan="2"><h2 class="groupheader"><a id="nested-classes" name="nested-classes"></a>
Classes</h2></td></tr>
<tr class="memitem:"><td class="memItemLeft" align="right" valign="top">class &#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="classStochTree_1_1GaussianConstantSuffStat.html">StochTree::GaussianConstantSuffStat</a></td></tr>
<tr class="memdesc:"><td class="mdescLeft">&#160;</td><td class="mdescRight">Sufficient statistic and associated operations for gaussian homoskedastic constant leaf outcome model.  <a href="classStochTree_1_1GaussianConstantSuffStat.html#details">More...</a><br /></td></tr>
<tr class="separator:"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:"><td class="memItemLeft" align="right" valign="top">class &#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="classStochTree_1_1GaussianConstantLeafModel.html">StochTree::GaussianConstantLeafModel</a></td></tr>
<tr class="memdesc:"><td class="mdescLeft">&#160;</td><td class="mdescRight">Marginal likelihood and posterior computation for gaussian homoskedastic constant leaf outcome model.  <a href="classStochTree_1_1GaussianConstantLeafModel.html#details">More...</a><br /></td></tr>
<tr class="separator:"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:"><td class="memItemLeft" align="right" valign="top">class &#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="classStochTree_1_1GaussianUnivariateRegressionSuffStat.html">StochTree::GaussianUnivariateRegressionSuffStat</a></td></tr>
<tr class="memdesc:"><td class="mdescLeft">&#160;</td><td class="mdescRight">Sufficient statistic and associated operations for gaussian homoskedastic constant leaf outcome model.  <a href="classStochTree_1_1GaussianUnivariateRegressionSuffStat.html#details">More...</a><br /></td></tr>
<tr class="separator:"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:"><td class="memItemLeft" align="right" valign="top">class &#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="classStochTree_1_1GaussianUnivariateRegressionLeafModel.html">StochTree::GaussianUnivariateRegressionLeafModel</a></td></tr>
<tr class="memdesc:"><td class="mdescLeft">&#160;</td><td class="mdescRight">Marginal likelihood and posterior computation for gaussian homoskedastic constant leaf outcome model.  <a href="classStochTree_1_1GaussianUnivariateRegressionLeafModel.html#details">More...</a><br /></td></tr>
<tr class="separator:"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:"><td class="memItemLeft" align="right" valign="top">class &#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="classStochTree_1_1GaussianMultivariateRegressionSuffStat.html">StochTree::GaussianMultivariateRegressionSuffStat</a></td></tr>
<tr class="memdesc:"><td class="mdescLeft">&#160;</td><td class="mdescRight">Sufficient statistic and associated operations for gaussian homoskedastic constant leaf outcome model.  <a href="classStochTree_1_1GaussianMultivariateRegressionSuffStat.html#details">More...</a><br /></td></tr>
<tr class="separator:"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:"><td class="memItemLeft" align="right" valign="top">class &#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="classStochTree_1_1GaussianMultivariateRegressionLeafModel.html">StochTree::GaussianMultivariateRegressionLeafModel</a></td></tr>
<tr class="memdesc:"><td class="mdescLeft">&#160;</td><td class="mdescRight">Marginal likelihood and posterior computation for gaussian homoskedastic constant leaf outcome model.  <a href="classStochTree_1_1GaussianMultivariateRegressionLeafModel.html#details">More...</a><br /></td></tr>
<tr class="separator:"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:"><td class="memItemLeft" align="right" valign="top">class &#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="classStochTree_1_1LogLinearVarianceSuffStat.html">StochTree::LogLinearVarianceSuffStat</a></td></tr>
<tr class="memdesc:"><td class="mdescLeft">&#160;</td><td class="mdescRight">Sufficient statistic and associated operations for heteroskedastic log-linear variance model.  <a href="classStochTree_1_1LogLinearVarianceSuffStat.html#details">More...</a><br /></td></tr>
<tr class="separator:"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:"><td class="memItemLeft" align="right" valign="top">class &#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="classStochTree_1_1LogLinearVarianceLeafModel.html">StochTree::LogLinearVarianceLeafModel</a></td></tr>
<tr class="memdesc:"><td class="mdescLeft">&#160;</td><td class="mdescRight">Marginal likelihood and posterior computation for heteroskedastic log-linear variance model.  <a href="classStochTree_1_1LogLinearVarianceLeafModel.html#details">More...</a><br /></td></tr>
<tr class="separator:"><td class="memSeparator" colspan="2">&#160;</td></tr>
</table><table class="memberdecls">
<tr class="heading"><td colspan="2"><h2 class="groupheader"><a id="typedef-members" name="typedef-members"></a>
Typedefs</h2></td></tr>
<tr class="memitem:ga3b4c0c2aa15bf379c20fb3a751b9f0f0" id="r_ga3b4c0c2aa15bf379c20fb3a751b9f0f0"><td class="memItemLeft" align="right" valign="top">using&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="group__leaf__model__group.html#ga3b4c0c2aa15bf379c20fb3a751b9f0f0">StochTree::SuffStatVariant</a> = std::variant&lt; <a class="el" href="classStochTree_1_1GaussianConstantSuffStat.html">GaussianConstantSuffStat</a>, <a class="el" href="classStochTree_1_1GaussianUnivariateRegressionSuffStat.html">GaussianUnivariateRegressionSuffStat</a>, <a class="el" href="classStochTree_1_1GaussianMultivariateRegressionSuffStat.html">GaussianMultivariateRegressionSuffStat</a>, <a class="el" href="classStochTree_1_1LogLinearVarianceSuffStat.html">LogLinearVarianceSuffStat</a> &gt;</td></tr>
<tr class="memdesc:ga3b4c0c2aa15bf379c20fb3a751b9f0f0"><td class="mdescLeft">&#160;</td><td class="mdescRight">Unifying layer for disparate sufficient statistic class types.  <br /></td></tr>
<tr class="separator:ga3b4c0c2aa15bf379c20fb3a751b9f0f0"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:gaf6e8634775db3810ef7a1dc42efd7059" id="r_gaf6e8634775db3810ef7a1dc42efd7059"><td class="memItemLeft" align="right" valign="top">using&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="group__leaf__model__group.html#gaf6e8634775db3810ef7a1dc42efd7059">StochTree::LeafModelVariant</a> = std::variant&lt; <a class="el" href="classStochTree_1_1GaussianConstantLeafModel.html">GaussianConstantLeafModel</a>, <a class="el" href="classStochTree_1_1GaussianUnivariateRegressionLeafModel.html">GaussianUnivariateRegressionLeafModel</a>, <a class="el" href="classStochTree_1_1GaussianMultivariateRegressionLeafModel.html">GaussianMultivariateRegressionLeafModel</a>, <a class="el" href="classStochTree_1_1LogLinearVarianceLeafModel.html">LogLinearVarianceLeafModel</a> &gt;</td></tr>
<tr class="memdesc:gaf6e8634775db3810ef7a1dc42efd7059"><td class="mdescLeft">&#160;</td><td class="mdescRight">Unifying layer for disparate leaf model class types.  <br /></td></tr>
<tr class="separator:gaf6e8634775db3810ef7a1dc42efd7059"><td class="memSeparator" colspan="2">&#160;</td></tr>
</table><table class="memberdecls">
<tr class="heading"><td colspan="2"><h2 class="groupheader"><a id="enum-members" name="enum-members"></a>
Enumerations</h2></td></tr>
<tr class="memitem:ga8cbfe035085adfd1a05335cf6f543a07" id="r_ga8cbfe035085adfd1a05335cf6f543a07"><td class="memItemLeft" align="right" valign="top">enum &#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="group__leaf__model__group.html#ga8cbfe035085adfd1a05335cf6f543a07">StochTree::ModelType</a> </td></tr>
<tr class="memdesc:ga8cbfe035085adfd1a05335cf6f543a07"><td class="mdescLeft">&#160;</td><td class="mdescRight">Leaf models for the forest sampler:  <a href="group__leaf__model__group.html#ga8cbfe035085adfd1a05335cf6f543a07">More...</a><br /></td></tr>
<tr class="separator:ga8cbfe035085adfd1a05335cf6f543a07"><td class="memSeparator" colspan="2">&#160;</td></tr>
</table><table class="memberdecls">
<tr class="heading"><td colspan="2"><h2 class="groupheader"><a id="func-members" name="func-members"></a>
Functions</h2></td></tr>
<tr class="memitem:ga1f479f37cb7892d7d9a4fe2c9fca9ed3" id="r_ga1f479f37cb7892d7d9a4fe2c9fca9ed3"><td class="memItemLeft" align="right" valign="top">static <a class="el" href="group__leaf__model__group.html#ga3b4c0c2aa15bf379c20fb3a751b9f0f0">SuffStatVariant</a>&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="group__leaf__model__group.html#ga1f479f37cb7892d7d9a4fe2c9fca9ed3">StochTree::suffStatFactory</a> (<a class="el" href="group__leaf__model__group.html#ga8cbfe035085adfd1a05335cf6f543a07">ModelType</a> model_type, int basis_dim=0)</td></tr>
<tr class="memdesc:ga1f479f37cb7892d7d9a4fe2c9fca9ed3"><td class="mdescLeft">&#160;</td><td class="mdescRight">Factory function that creates a new <code>SuffStat</code> object for the specified model type.  <br /></td></tr>
<tr class="separator:ga1f479f37cb7892d7d9a4fe2c9fca9ed3"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:gaaba5f1e9af5724f79d1387fc97f7fc09" id="r_gaaba5f1e9af5724f79d1387fc97f7fc09"><td class="memItemLeft" align="right" valign="top">static <a class="el" href="group__leaf__model__group.html#gaf6e8634775db3810ef7a1dc42efd7059">LeafModelVariant</a>&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="group__leaf__model__group.html#gaaba5f1e9af5724f79d1387fc97f7fc09">StochTree::leafModelFactory</a> (<a class="el" href="group__leaf__model__group.html#ga8cbfe035085adfd1a05335cf6f543a07">ModelType</a> model_type, double tau, Eigen::MatrixXd &amp;Sigma0, double a, double b)</td></tr>
<tr class="memdesc:gaaba5f1e9af5724f79d1387fc97f7fc09"><td class="mdescLeft">&#160;</td><td class="mdescRight">Factory function that creates a new <code>LeafModel</code> object for the specified model type.  <br /></td></tr>
<tr class="separator:gaaba5f1e9af5724f79d1387fc97f7fc09"><td class="memSeparator" colspan="2">&#160;</td></tr>
</table>
<a name="details" id="details"></a><h2 class="groupheader">Detailed Description</h2>
<p>Classes / functions for implementing leaf models. </p>
<p>Stochastic tree algorithms are all essentially hierarchical models with an adaptive group structure defined by an ensemble of decision trees. Each novel model is governed by</p>
<ul>
<li>A <code>LeafModel</code> class, defining the integrated likelihood and posterior, conditional on a particular tree structure</li>
<li>A <code>SuffStat</code> class that tracks and accumulates sufficient statistics necessary for a <code>LeafModel</code></li>
</ul>
<p>To provide a thorough overview of this interface (and, importantly, how to extend it), we must introduce some mathematical notation. Any forest-based regression model involves an outcome, which we'll call \(y\), and features (or "covariates"), which we'll call \(X\). Our goal is to predict \(y\) as a function of \(X\), which we'll call \(f(X)\).</p>
<p><em>NOTE:</em> if we have a more complicated, but still additive, model, such as \(y = X\beta + f(X)\), then we can just model \(y - X\beta = f(X)\), treating the residual \(y - X\beta\) as the outcome data, and we are back to the general setting above.</p>
<p>Now, since \(f(X)\) is an additive tree ensemble, we can think of it as the sum of \(b\) separate decision tree functions, where \(b\) is the number of trees in an ensemble, so that</p>
<p class="formulaDsp">
\[
   f(X) = f_1(X) + \dots + f_b(X)
 \]
</p>
<p>and each decision tree function \(f_j\) has the property that features \(X\) are used to determine which leaf node an observation falls into, and then the parameters attached to that leaf node are used to compute \(f_j(X)\). The exact mechanics of this process are model-dependent, so now we introduce the "leaf node" models that <code>stochtree</code> supports.</p>
<h1><a class="anchor" id="gaussian_constant_leaf_model"></a>
Gaussian Constant Leaf Model</h1>
<p>The most standard and common tree ensemble is a sum of "constant leaf" trees, in which a leaf node's parameter uniquely determines the prediction for all observations that fall into that leaf. For example, if leaf 2 for a tree is reached by the conditions that \(X_1 &lt; 0.4 \; \&amp; \; X_2 &gt; 0.6\), then every observation whose first feature is less than 0.4 and whose second feature is greater than 0.6 will receive the same prediction. Mathematically, for an observation \(i\) this looks like</p>
<p class="formulaDsp">
\[
   f_j(X_i) = \sum_{\ell \in L} \mathbb{1}(X_i \in \ell) \mu_{\ell}
 \]
</p>
<p>where \(L\) denotes the indices of every leaf node, \(\mu_{\ell}\) is the parameter attached to leaf node \(\ell\), and \(\mathbb{1}(X \in \ell)\) checks whether \(X_i\) falls into leaf node \(\ell\).</p>
<p>The way that we make such a model "stochastic" is by attaching to the leaf node parameters \(\mu_{\ell}\) a "prior" distribution. This leaf model corresponds to the "classic" BART model of <a href="https://projecteuclid.org/journals/annals-of-applied-statistics/volume-4/issue-1/BART-Bayesian-additive-regression-trees/10.1214/09-AOAS285.full">Chipman et al (2010)</a> as well as its "XBART" extension (<a href="https://www.tandfonline.com/doi/full/10.1080/01621459.2021.1942012">He and Hahn (2023)</a>). We assign each leaf node parameter a prior</p>
<p class="formulaDsp">
\[
   \mu \sim N\left(0, \tau\right)
 \]
</p>
<p>Assuming a homoskedastic Gaussian outcome likelihood (i.e. \(y_i \sim N\left(f(X_i),\sigma^2\right)\)), the log marginal likelihood in this model, for the outcome data in node \(\ell\) of tree \(j\) is given by</p>
<p class="formulaDsp">
\[
   L(y) = -\frac{n_{\ell}}{2}\log(2\pi) - n_{\ell}\log(\sigma) + \frac{1}{2} \log\left(\frac{\sigma^2}{n_{\ell} \tau + \sigma^2}\right) - \frac{s_{yy,\ell}}{2\sigma^2} + \frac{\tau s_{y,\ell}^2}{2\sigma^2(n_{\ell} \tau + \sigma^2)}
 \]
</p>
<p>where</p>
<p class="formulaDsp">
\[
   n_{\ell} = \sum_{i : X_i \in \ell} 1
 \]
</p>
<p class="formulaDsp">
\[
   s_{y,\ell} = \sum_{i : X_i \in \ell} r_i
 \]
</p>
<p class="formulaDsp">
\[
   s_{yy,\ell} = \sum_{i : X_i \in \ell} r_i^2
 \]
</p>
<p class="formulaDsp">
\[
   r_i = y_i - \sum_{k \neq j} f_k(X_i)
 \]
</p>
<p>In words, this model depends on the data for a given leaf node only through three sufficient statistics, \(n_{\ell}\), \(s_{y,\ell}\), and \(s_{yy,\ell}\), and it only depends on the other trees in the ensemble through the "partial residual" \(r_i\). The posterior distribution for node \(\ell\)'s leaf parameter is similarly defined as:</p>
<p class="formulaDsp">
\[
   \mu_{\ell} \mid - \sim N\left(\frac{\tau s_{y,\ell}}{n_{\ell} \tau + \sigma^2}, \frac{\tau \sigma^2}{n_{\ell} \tau + \sigma^2}\right)
 \]
</p>
<p>Now, consider the possibility that each observation carries a unique weight \(w_i\). These could be "case weights" in a survey context or individual-level variances ("heteroskedasticity"). These case weights transform the outcome distribution (and associated likelihood) to</p>
<p class="formulaDsp">
\[
   y_i \mid - \sim N\left(\mu(X_i), \frac{\sigma^2}{w_i}\right) 
 \]
</p>
<p>This gives a modified log marginal likelihood of</p>
<p class="formulaDsp">
\[
   L(y) = -\frac{n_{\ell}}{2}\log(2\pi) - \frac{1}{2} \sum_{i : X_i \in \ell} \log\left(\frac{\sigma^2}{w_i}\right) + \frac{1}{2} \log\left(\frac{\sigma^2}{s_{w,\ell} \tau + \sigma^2}\right) - \frac{s_{wyy,\ell}}{2\sigma^2} + \frac{\tau s_{wy,\ell}^2}{2\sigma^2(s_{w,\ell} \tau + \sigma^2)}
 \]
</p>
<p>where</p>
<p class="formulaDsp">
\[
   s_{w,\ell} = \sum_{i : X_i \in \ell} w_i
 \]
</p>
<p class="formulaDsp">
\[
   s_{wy,\ell} = \sum_{i : X_i \in \ell} w_i r_i
 \]
</p>
<p class="formulaDsp">
\[
   s_{wyy,\ell} = \sum_{i : X_i \in \ell} w_i r_i^2
 \]
</p>
<p>Finally, note that when we consider splitting leaf \(\ell\) into new left and right leaves, or pruning two nodes into a single leaf node, we compute the log marginal likelihood of the combined data and the log marginal likelihoods of the left and right leaves and compare these three values.</p>
<p>The terms \(\frac{n_{\ell}}{2}\log(2\pi)\), \(\sum_{i : X_i \in \ell} \log\left(\frac{\sigma^2}{w_i}\right)\), and \(\frac{s_{wyy,\ell}}{2\sigma^2}\) are such that their left and right node values will always sum to the respective value in the combined log marginal likelihood, so they can be ignored when evaluating splits or prunes and thus the reduced log marginal likelihood is</p>
<p class="formulaDsp">
\[
   L(y) \propto \frac{1}{2} \log\left(\frac{\sigma^2}{s_{w,\ell} \tau + \sigma^2}\right) + \frac{\tau s_{wy,\ell}^2}{2\sigma^2(n_{\ell} \tau + \sigma^2)}
 \]
</p>
<p>So the <a class="el" href="classStochTree_1_1GaussianConstantSuffStat.html">GaussianConstantSuffStat</a> class tracks a generalized version of these three statistics (which allows for each observation to have a weight \(w_i \neq 1\)):</p>
<ul>
<li>\(n_{\ell}\): <code>data_size_t n</code></li>
<li>\(s_{w,\ell}\): <code>double sum_w</code></li>
<li>\(s_{wy,\ell}\): <code>double sum_yw</code></li>
</ul>
<p>And these values are used by the <a class="el" href="classStochTree_1_1GaussianConstantLeafModel.html">GaussianConstantLeafModel</a> class in the <a class="el" href="classStochTree_1_1GaussianConstantLeafModel.html#a17606e57c26fbf44471659dba67d1b0a">SplitLogMarginalLikelihood</a>, <a class="el" href="classStochTree_1_1GaussianConstantLeafModel.html#a35ff415dc96dfbb1423c116b15bcbec8">NoSplitLogMarginalLikelihood</a>, <a class="el" href="classStochTree_1_1GaussianConstantLeafModel.html#aa93543fbf51aecc1c054d27d2fb4df1b">PosteriorParameterMean</a>, and <a class="el" href="classStochTree_1_1GaussianConstantLeafModel.html#a1decfd8e8d40157da1d6d5b1b8bef7d2">PosteriorParameterVariance</a> methods. To give one example, below is the implementation of <a class="el" href="classStochTree_1_1GaussianConstantLeafModel.html#a17606e57c26fbf44471659dba67d1b0a">SplitLogMarginalLikelihood</a>:</p>
<div class="fragment"><div class="line"><span class="keywordtype">double</span> left_log_ml = (</div>
<div class="line">   -0.5*std::log(1 + tau_*(left_stat.sum_w/global_variance)) + ((tau_*left_stat.sum_yw*left_stat.sum_yw)/(2.0*global_variance*(tau_*left_stat.sum_w + global_variance)))</div>
<div class="line">);</div>
<div class="line"> </div>
<div class="line"><span class="keywordtype">double</span> right_log_ml = (</div>
<div class="line">   -0.5*std::log(1 + tau_*(right_stat.sum_w/global_variance)) + ((tau_*right_stat.sum_yw*right_stat.sum_yw)/(2.0*global_variance*(tau_*right_stat.sum_w + global_variance)))</div>
<div class="line">);</div>
<div class="line"> </div>
<div class="line"><span class="keywordflow">return</span> left_log_ml + right_log_ml;</div>
</div><!-- fragment --><h1><a class="anchor" id="gaussian_multivariate_regression_leaf_model"></a>
Gaussian Multivariate Regression Leaf Model</h1>
<p>In this model, the tree defines a "partitioned linear model" in which leaf node parameters define regression weights that are multiplied by a "basis" \(\Omega\) to determine the prediction for an observation.</p>
<p class="formulaDsp">
\[
   f_j(X_i) = \sum_{\ell \in L} \mathbb{1}(X_i \in \ell) \Omega_i \vec{\beta_{\ell}}
 \]
</p>
<p>and we assign \(\beta_{\ell}\) a prior of</p>
<p class="formulaDsp">
\[
   \vec{\beta_{\ell}} \sim N\left(\vec{\beta_0}, \Sigma_0\right)
 \]
</p>
<p>where \(\vec{\beta_0}\) is typically a vector of zeros. The outcome likelihood is still</p>
<p class="formulaDsp">
\[
   y_i \sim N\left(f(X_i), \sigma^2\right)
 \]
</p>
<p>This gives a reduced log integrated likelihood of</p>
<p class="formulaDsp">
\[
   L(y) \propto - \frac{1}{2} \log\left(\textrm{det}\left(I_p + \frac{\Sigma_0\Omega&#39;\Omega}{\sigma^2}\right)\right) + \frac{1}{2}\frac{y&#39;\Omega}{\sigma^2}\left(\Sigma_0^{-1} + \frac{\Omega&#39;\Omega}{\sigma^2}\right)^{-1}\frac{\Omega&#39;y}{\sigma^2}
 \]
</p>
<p>where \(\Omega\) is a matrix of bases for every observation in leaf \(\ell\) and \(p\) is the dimension of \(\Omega\). The posterior for \(\vec{\beta_{\ell}}\) is</p>
<p class="formulaDsp">
\[
   \vec{\beta_{\ell}} \sim N\left(\left(\Sigma_0^{-1} + \frac{\Omega&#39;\Omega}{\sigma^2}\right)^{-1}\left(\frac{\Omega&#39;y}{\sigma^2}\right),\left(\Sigma_0^{-1} + \frac{\Omega&#39;\Omega}{\sigma^2}\right)^{-1}\right)
 \]
</p>
<p>This is an extension of the single-tree model of <a href="https://link.springer.com/article/10.1023/A:1013916107446">Chipman et al (2002)</a>, with:</p>
<ul>
<li>Support for using a separate basis for leaf model than the partitioning (i.e. tree) model (i.e. \(X \neq \Omega\))</li>
<li>Support for multiple trees and sampling via grow-from-root (GFR) or MCMC</li>
</ul>
<p>We can also enable heteroskedasticity by defining a (diagonal) covariance matrix for the outcome likelihood</p>
<p class="formulaDsp">
\[
   \Sigma_y = \text{diag}\left(\sigma^2 / w_1,\sigma^2 / w_2,\dots,\sigma^2 / w_n\right)
 \]
</p>
<p>This updates the reduced log integrated likelihood to</p>
<p class="formulaDsp">
\[
   L(y) \propto - \frac{1}{2} \log\left(\textrm{det}\left(I_p + \Sigma_{0}\Omega&#39;\Sigma_y^{-1}\Omega\right)\right) + \frac{1}{2}y&#39;\Sigma_{y}^{-1}\Omega\left(\Sigma_{0}^{-1} + \Omega&#39;\Sigma_{y}^{-1}\Omega\right)^{-1}\Omega&#39;\Sigma_{y}^{-1}y
 \]
</p>
<p>and a posterior for \(\vec{\beta_{\ell}}\) of</p>
<p class="formulaDsp">
\[
   \vec{\beta_{\ell}} \sim N\left(\left(\Sigma_{0}^{-1} + \Omega&#39;\Sigma_{y}^{-1}\Omega\right)^{-1}\left(\Omega&#39;\Sigma_{y}^{-1}y\right),\left(\Sigma_{0}^{-1} + \Omega&#39;\Sigma_{y}^{-1}\Omega\right)^{-1}\right)
 \]
</p>
<h1><a class="anchor" id="gaussian_univariate_regression_leaf_model"></a>
Gaussian Univariate Regression Leaf Model</h1>
<p>This specializes the Gaussian Multivariate Regression Leaf Model for a univariate leaf basis, which allows for several computational speedups (replacing generalized matrix operations with simple summation or sum-product operations). We simplify \(\Omega\) to \(\omega\), a univariate basis for every observation, so that \(\Omega&#39;\Omega = \sum_{i:i \in \ell}\omega_i^2\) and \(\Omega&#39;y = \sum_{i:i \in \ell}\omega_ir_i\). Similarly, the prior for the leaf parameter becomes univariate normal as in gaussian_constant_leaf_model:</p>
<p class="formulaDsp">
\[
   \beta \sim N\left(0, \tau\right)
 \]
</p>
<p>Allowing for case / variance weights \(w_i\) as above, we derive a reduced log marginal likelihood of</p>
<p class="formulaDsp">
\[
   L(y) \propto \frac{1}{2} \log\left(\frac{\sigma^2}{s_{wxx,\ell} \tau + \sigma^2}\right) + \frac{\tau s_{wyx,\ell}^2}{2\sigma^2(s_{wxx,\ell} \tau + \sigma^2)}
 \]
</p>
<p>where</p>
<p class="formulaDsp">
\[
   s_{wxx,\ell} = \sum_{i : X_i \in \ell} w_i \omega_i \omega_i
 \]
</p>
<p class="formulaDsp">
\[
   s_{wyx,\ell} = \sum_{i : X_i \in \ell} w_i r_i \omega_i
 \]
</p>
<p>and a posterior of</p>
<p class="formulaDsp">
\[
   \beta_{\ell} \mid - \sim N\left(\frac{\tau s_{wyx,\ell}}{s_{wxx,\ell} \tau + \sigma^2}, \frac{\tau \sigma^2}{s_{wxx,\ell} \tau + \sigma^2}\right)
 \]
</p>
<h1><a class="anchor" id="inverse_gamma_leaf_model"></a>
Inverse Gamma Leaf Model</h1>
<p>Each of the above models is a variation on a theme: a conjugate, partitioned Gaussian leaf model. The inverse gamma leaf model allows for forest-based heteroskedasticity modeling using an inverse gamma prior on the exponentiated leaf parameter, as discussed in <a href="https://www.tandfonline.com/doi/full/10.1080/01621459.2020.1813587">Murray (2021)</a> Define a variance function based on an ensemble of \(b\) trees as</p>
<p class="formulaDsp">
\[
   \sigma^2(X) = \exp\left(s_1(X) + \dots + s_b(X)\right)
 \]
</p>
<p>where each tree function \(s_j(X)\) is defined as</p>
<p class="formulaDsp">
\[
   s_j(X_i) = \sum_{\ell \in L} \mathbb{1}(X_i \in \ell) \lambda_{\ell}
 \]
</p>
<p>We reparameterize \(\lambda_{\ell} = \log(\mu_{\ell})\) and we place an inverse gamma prior on \(\mu_{\ell}\)</p>
<p class="formulaDsp">
\[
   \mu_{\ell} \sim \text{IG}\left(a, b\right)
 \]
</p>
<p>As noted in <a href="https://www.tandfonline.com/doi/full/10.1080/01621459.2020.1813587">Murray (2021)</a>, this model no longer enables the "Bayesian backfitting" simplification of conjugated Gaussian leaf models, in which sampling updates for a given tree only depend on other trees in the ensemble via their imprint on the partial residual \(r_i = y_i - \sum_{k \neq j} \mu_k(X_i)\). However, this model is part of a broader class of models with convenient "blocked MCMC" sampling updates (another important example being multinomial classification).</p>
<p>Under an outcome model</p>
<p class="formulaDsp">
\[
   y \sim N\left(f(X), \sigma_0^2 \sigma^2(X)\right)
 \]
</p>
<p>updates to \(\mu_{\ell}\) for a given tree \(j\) are based on a reduced log marginal likelihood of</p>
<p class="formulaDsp">
\[
   L(y) \propto a \log (b) - \log \Gamma (a) + \log \Gamma \left(a + \frac{n_{\ell}}{2}\right) - \left(a + \frac{n_{\ell}}{2}\right) \left(b + \frac{s_{\sigma,\ell}}{2\sigma_0^2}\right)
 \]
</p>
<p>where</p>
<p class="formulaDsp">
\[
   n_{\ell} = \sum_{i : X_i \in \ell} 1
 \]
</p>
<p class="formulaDsp">
\[
   s_{\sigma,\ell} = \sum_{i: i \in \ell} \frac{(y_i - f(X_i))^2}{\prod_{k \neq j} s_k(X_i)}
 \]
</p>
<p>and a posterior of</p>
<p class="formulaDsp">
\[
   \mu_{\ell} \mid - \sim \text{IG}\left( a + \frac{n_{\ell}}{2} , b + \frac{s_{\sigma,\ell}}{2\sigma_0^2} \right)
 \]
</p>
<p>Thus, as above, we implement a sufficient statistic class (<a class="el" href="classStochTree_1_1LogLinearVarianceSuffStat.html">LogLinearVarianceSuffStat</a>), which tracks</p>
<ul>
<li>\(n_{\ell}\): <code>data_size_t n</code></li>
<li>\(s_{\sigma,\ell}\): <code>double weighted_sum_ei</code></li>
</ul>
<p>And these values are used by the <a class="el" href="classStochTree_1_1LogLinearVarianceLeafModel.html">LogLinearVarianceLeafModel</a> class in the <a class="el" href="classStochTree_1_1LogLinearVarianceLeafModel.html#aa3be480caf6815a2229f18d5e4fffe36">SplitLogMarginalLikelihood</a>, <a class="el" href="classStochTree_1_1LogLinearVarianceLeafModel.html#a0fadf6803b9d83cbad1645e8ece3b6d1">NoSplitLogMarginalLikelihood</a>, <a class="el" href="classStochTree_1_1LogLinearVarianceLeafModel.html#a2b2c44276317b82c3e6926491e92f4d0">PosteriorParameterShape</a>, and <a class="el" href="classStochTree_1_1LogLinearVarianceLeafModel.html#aebacfcd43076825121bededd92d021b0">PosteriorParameterScale</a> methods. To give one example, below is the implementation of <a class="el" href="classStochTree_1_1LogLinearVarianceLeafModel.html#a0fadf6803b9d83cbad1645e8ece3b6d1">NoSplitLogMarginalLikelihood</a>:</p>
<div class="fragment"><div class="line"><span class="keywordtype">double</span> prior_terms = a_ * std::log(b_) - boost::math::lgamma(a_);</div>
<div class="line"><span class="keywordtype">double</span> a_term = a_ + 0.5 * suff_stat.n;</div>
<div class="line"><span class="keywordtype">double</span> b_term = b_ + ((0.5 * suff_stat.weighted_sum_ei) / global_variance);</div>
<div class="line"><span class="keywordtype">double</span> log_b_term = std::log(b_term);</div>
<div class="line"><span class="keywordtype">double</span> lgamma_a_term = boost::math::lgamma(a_term);</div>
<div class="line"><span class="keywordtype">double</span> resid_term = a_term * log_b_term;</div>
<div class="line"><span class="keywordtype">double</span> log_ml = prior_terms + lgamma_a_term - resid_term;</div>
<div class="line"><span class="keywordflow">return</span> log_ml;</div>
</div><!-- fragment --> <h2 class="groupheader">Typedef Documentation</h2>
<a id="ga3b4c0c2aa15bf379c20fb3a751b9f0f0" name="ga3b4c0c2aa15bf379c20fb3a751b9f0f0"></a>
<h2 class="memtitle"><span class="permalink"><a href="#ga3b4c0c2aa15bf379c20fb3a751b9f0f0">&#9670;&#160;</a></span>SuffStatVariant</h2>

<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">using <a class="el" href="group__leaf__model__group.html#ga3b4c0c2aa15bf379c20fb3a751b9f0f0">StochTree::SuffStatVariant</a> = typedef std::variant&lt;<a class="el" href="classStochTree_1_1GaussianConstantSuffStat.html">GaussianConstantSuffStat</a>, <a class="el" href="classStochTree_1_1GaussianUnivariateRegressionSuffStat.html">GaussianUnivariateRegressionSuffStat</a>, <a class="el" href="classStochTree_1_1GaussianMultivariateRegressionSuffStat.html">GaussianMultivariateRegressionSuffStat</a>, <a class="el" href="classStochTree_1_1LogLinearVarianceSuffStat.html">LogLinearVarianceSuffStat</a>&gt;</td>
        </tr>
      </table>
</div><div class="memdoc">

<p>Unifying layer for disparate sufficient statistic class types. </p>
<p>Joins together <a class="el" href="classStochTree_1_1GaussianConstantSuffStat.html" title="Sufficient statistic and associated operations for gaussian homoskedastic constant leaf outcome model...">GaussianConstantSuffStat</a>, <a class="el" href="classStochTree_1_1GaussianUnivariateRegressionSuffStat.html" title="Sufficient statistic and associated operations for gaussian homoskedastic constant leaf outcome model...">GaussianUnivariateRegressionSuffStat</a>, <a class="el" href="classStochTree_1_1GaussianMultivariateRegressionSuffStat.html" title="Sufficient statistic and associated operations for gaussian homoskedastic constant leaf outcome model...">GaussianMultivariateRegressionSuffStat</a>, and <a class="el" href="classStochTree_1_1LogLinearVarianceSuffStat.html" title="Sufficient statistic and associated operations for heteroskedastic log-linear variance model.">LogLinearVarianceSuffStat</a> as a combined "variant" type. See <a href="https://en.cppreference.com/w/cpp/utility/variant">the std::variant documentation</a> for more detail. </p>

</div>
</div>
<a id="gaf6e8634775db3810ef7a1dc42efd7059" name="gaf6e8634775db3810ef7a1dc42efd7059"></a>
<h2 class="memtitle"><span class="permalink"><a href="#gaf6e8634775db3810ef7a1dc42efd7059">&#9670;&#160;</a></span>LeafModelVariant</h2>

<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">using <a class="el" href="group__leaf__model__group.html#gaf6e8634775db3810ef7a1dc42efd7059">StochTree::LeafModelVariant</a> = typedef std::variant&lt;<a class="el" href="classStochTree_1_1GaussianConstantLeafModel.html">GaussianConstantLeafModel</a>, <a class="el" href="classStochTree_1_1GaussianUnivariateRegressionLeafModel.html">GaussianUnivariateRegressionLeafModel</a>, <a class="el" href="classStochTree_1_1GaussianMultivariateRegressionLeafModel.html">GaussianMultivariateRegressionLeafModel</a>, <a class="el" href="classStochTree_1_1LogLinearVarianceLeafModel.html">LogLinearVarianceLeafModel</a>&gt;</td>
        </tr>
      </table>
</div><div class="memdoc">

<p>Unifying layer for disparate leaf model class types. </p>
<p>Joins together <a class="el" href="classStochTree_1_1GaussianConstantLeafModel.html" title="Marginal likelihood and posterior computation for gaussian homoskedastic constant leaf outcome model.">GaussianConstantLeafModel</a>, <a class="el" href="classStochTree_1_1GaussianUnivariateRegressionLeafModel.html" title="Marginal likelihood and posterior computation for gaussian homoskedastic constant leaf outcome model.">GaussianUnivariateRegressionLeafModel</a>, <a class="el" href="classStochTree_1_1GaussianMultivariateRegressionLeafModel.html" title="Marginal likelihood and posterior computation for gaussian homoskedastic constant leaf outcome model.">GaussianMultivariateRegressionLeafModel</a>, and <a class="el" href="classStochTree_1_1LogLinearVarianceLeafModel.html" title="Marginal likelihood and posterior computation for heteroskedastic log-linear variance model.">LogLinearVarianceLeafModel</a> as a combined "variant" type. See <a href="https://en.cppreference.com/w/cpp/utility/variant">the std::variant documentation</a> for more detail. </p>

</div>
</div>
<h2 class="groupheader">Enumeration Type Documentation</h2>
<a id="ga8cbfe035085adfd1a05335cf6f543a07" name="ga8cbfe035085adfd1a05335cf6f543a07"></a>
<h2 class="memtitle"><span class="permalink"><a href="#ga8cbfe035085adfd1a05335cf6f543a07">&#9670;&#160;</a></span>ModelType</h2>

<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">enum <a class="el" href="group__leaf__model__group.html#ga8cbfe035085adfd1a05335cf6f543a07">StochTree::ModelType</a></td>
        </tr>
      </table>
</div><div class="memdoc">

<p>Leaf models for the forest sampler: </p>
<ol type="1">
<li><code>kConstantLeafGaussian</code>: Every leaf node has a zero-centered univariate normal prior and every leaf is constant.</li>
<li><code>kUnivariateRegressionLeafGaussian</code>: Every leaf node has a zero-centered univariate normal prior and every leaf is a linear model, multiplying the leaf parameter by a (fixed) basis.</li>
<li><code>kMultivariateRegressionLeafGaussian</code>: Every leaf node has a multivariate normal prior, centered around the zero vector, and every leaf is a linear model, matrix-multiplying the leaf parameters by a (fixed) basis vector.</li>
<li><code>kLogLinearVariance</code>: Every leaf node has a inverse gamma prior and every leaf is constant. </li>
</ol>

</div>
</div>
<h2 class="groupheader">Function Documentation</h2>
<a id="ga1f479f37cb7892d7d9a4fe2c9fca9ed3" name="ga1f479f37cb7892d7d9a4fe2c9fca9ed3"></a>
<h2 class="memtitle"><span class="permalink"><a href="#ga1f479f37cb7892d7d9a4fe2c9fca9ed3">&#9670;&#160;</a></span>suffStatFactory()</h2>

<div class="memitem">
<div class="memproto">
<table class="mlabels">
  <tr>
  <td class="mlabels-left">
      <table class="memname">
        <tr>
          <td class="memname">static <a class="el" href="group__leaf__model__group.html#ga3b4c0c2aa15bf379c20fb3a751b9f0f0">SuffStatVariant</a> StochTree::suffStatFactory </td>
          <td>(</td>
          <td class="paramtype"><a class="el" href="group__leaf__model__group.html#ga8cbfe035085adfd1a05335cf6f543a07">ModelType</a>&#160;</td>
          <td class="paramname"><em>model_type</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">int&#160;</td>
          <td class="paramname"><em>basis_dim</em> = <code>0</code>&#160;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td>
        </tr>
      </table>
  </td>
  <td class="mlabels-right">
<span class="mlabels"><span class="mlabel">inline</span><span class="mlabel">static</span></span>  </td>
  </tr>
</table>
</div><div class="memdoc">

<p>Factory function that creates a new <code>SuffStat</code> object for the specified model type. </p>
<dl class="params"><dt>Parameters</dt><dd>
  <table class="params">
    <tr><td class="paramname">model_type</td><td>Enumeration storing the model type </td></tr>
    <tr><td class="paramname">basis_dim</td><td>[Optional] dimension of the basis vector, only used if <code>model_type = kMultivariateRegressionLeafGaussian</code> </td></tr>
  </table>
  </dd>
</dl>

</div>
</div>
<a id="gaaba5f1e9af5724f79d1387fc97f7fc09" name="gaaba5f1e9af5724f79d1387fc97f7fc09"></a>
<h2 class="memtitle"><span class="permalink"><a href="#gaaba5f1e9af5724f79d1387fc97f7fc09">&#9670;&#160;</a></span>leafModelFactory()</h2>

<div class="memitem">
<div class="memproto">
<table class="mlabels">
  <tr>
  <td class="mlabels-left">
      <table class="memname">
        <tr>
          <td class="memname">static <a class="el" href="group__leaf__model__group.html#gaf6e8634775db3810ef7a1dc42efd7059">LeafModelVariant</a> StochTree::leafModelFactory </td>
          <td>(</td>
          <td class="paramtype"><a class="el" href="group__leaf__model__group.html#ga8cbfe035085adfd1a05335cf6f543a07">ModelType</a>&#160;</td>
          <td class="paramname"><em>model_type</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">double&#160;</td>
          <td class="paramname"><em>tau</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">Eigen::MatrixXd &amp;&#160;</td>
          <td class="paramname"><em>Sigma0</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">double&#160;</td>
          <td class="paramname"><em>a</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">double&#160;</td>
          <td class="paramname"><em>b</em>&#160;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td>
        </tr>
      </table>
  </td>
  <td class="mlabels-right">
<span class="mlabels"><span class="mlabel">inline</span><span class="mlabel">static</span></span>  </td>
  </tr>
</table>
</div><div class="memdoc">

<p>Factory function that creates a new <code>LeafModel</code> object for the specified model type. </p>
<dl class="params"><dt>Parameters</dt><dd>
  <table class="params">
    <tr><td class="paramname">model_type</td><td>Enumeration storing the model type </td></tr>
    <tr><td class="paramname">tau</td><td>Value of the leaf node prior scale parameter, only used if <code>model_type = kConstantLeafGaussian</code> or <code>model_type = kUnivariateRegressionLeafGaussian</code> </td></tr>
    <tr><td class="paramname">Sigma0</td><td>Value of the leaf node prior covariance matrix, only used if <code>model_type = kMultivariateRegressionLeafGaussian</code> </td></tr>
    <tr><td class="paramname">a</td><td>Value of the leaf node inverse gamma prior shape parameter, only used if <code>model_type = kLogLinearVariance</code> </td></tr>
    <tr><td class="paramname">b</td><td>Value of the leaf node inverse gamma prior scale parameter, only used if <code>model_type = kLogLinearVariance</code> </td></tr>
  </table>
  </dd>
</dl>

</div>
</div>
</div><!-- contents -->
<!-- start footer part -->
<hr class="footer"/><address class="footer"><small>
Generated by&#160;<a href="https://www.doxygen.org/index.html"><img class="footer" src="doxygen.svg" width="104" height="31" alt="doxygen"/></a> 1.9.8
</small></address>
</body>
</html>
